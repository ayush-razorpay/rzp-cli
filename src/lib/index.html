<!DOCTYPE html>
<html>

<head>
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
  <!-- MDB -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.5.0/mdb.min.css" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/jsoneditor@9.2.0/dist/jsoneditor.min.css" rel="stylesheet" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>

  <!-- Modal -->
  <div class="modal fade" id="staticBackdrop" data-mdb-backdrop="static" data-mdb-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">

    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">View / Edit & Replay</h5>
          <button type="button" class="btn-close" data-mdb-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body"> <code id="dat"></code></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-mdb-dismiss="modal">
            Close
          </button>
          <button type="button" onclick="retrigger()" class="btn btn-primary">Retrigger</button>
        </div>
      </div>
    </div>


  </div>
  <div class="container">
    <div class="table-responsive">
      <table id="table" class="table table-striped table-bordered table-sm">
        <thead>
          <tr class="table-dark">
            <th scope="col">#</th>
            <th scope="col">Timestamp</th>
            <th scope="col">Created At</th>
            <th scope="col">Event Type</th>
            <th scope="col">Event Id</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
  <!-- MDB -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.5.0/mdb.min.js"></script>
  <script type="text/javascript" src="  https://cdn.jsdelivr.net/npm/jsoneditor@9.4.1/dist/jsoneditor.min.js"></script>


  <script>


    const container = document.getElementById("dat")
    // const options = {}
    // const editor = new JSONEditor(container, options)


    $(document).ready(function () {
      console.log("ready!");

      var settings = {
        url: "/replay/data",
        method: "GET",
        timeout: 0,
      };

      $.ajax(settings).done(function (response) {
        console.log(response);

        response.data.forEach((element, index) => {
          var table = document.getElementById("table");
          var row = table.insertRow();
      row.insertCell().innerHTML = index + 1;;
      row.insertCell().innerHTML = formatTimestamp(new Date(element.timeStamp));
      row.insertCell().innerHTML = formatTimestamp(new Date(element.created_at));
      row.insertCell().innerHTML =  element.event;
      row.insertCell().innerHTML =  element.id;      

          let objJsonB64 = btoa(JSON.stringify(element))
          let t =
            '<button  type="button" class="btn btn-primary" data-mdb-toggle="modal" onClick=setModalText(&quot;' +
            objJsonB64 +
            '&quot;) data-mdb-target="#staticBackdrop" >view / edit & retrigger </button>';
            row.insertCell().innerHTML = t;
        });
      });
    });

    function formatTimestamp(t){
      const date = ('0' + t.getDate()).slice(-2);
const month = ('0' + (t.getMonth() + 1)).slice(-2);
const year = t.getFullYear();
const hours = ('0' + t.getHours()).slice(-2);
const minutes = ('0' + t.getMinutes()).slice(-2);
const seconds = ('0' + t.getSeconds()).slice(-2);
const time = `${date}/${month}/${year}, ${hours}:${minutes}:${seconds}`;
return time;
    }

    function setModalText(x) {



      document.getElementById("dat").innerHTML = "";
      const options = {}
      editor = new JSONEditor(container, options)
      var actual = JSON.parse(atob(x))

      console.log("-------", actual);

      if (actual.headers['x-razorpay-signature']) {
        actual.headers = {
          'x-razorpay-signature': actual.headers['x-razorpay-signature']
        };

      }
      editor.set(actual)
      //document.getElementById("dat").textContent = JSON.stringify(actual,null,"\t");
    }

    function retrigger() {
      const updatedJson = editor.get();

      console.log(updatedJson);
      let temp = JSON.parse(JSON.stringify(updatedJson));
      const xhr = new XMLHttpRequest()
      xhr.withCredentials = true

      xhr.addEventListener('readystatechange', function () {
        if (this.readyState === this.DONE) {

          let temp = JSON.parse(this.responseText);
          if (temp.statusCode == 200) {
            alert("success")
          } else {
            alert("failure")
          }
          console.log(this.responseText)
        }
      })
      xhr.open('POST', '/replay/retrigger')
      xhr.setRequestHeader('content-type', 'application/json')
      xhr.send(JSON.stringify(temp))
    }
  </script>
</body>

</html>